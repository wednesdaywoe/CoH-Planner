<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incarnate System UI - With Icons</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0A0E1A;
            --bg-secondary: #131826;
            --bg-tertiary: #1C2333;
            --text-primary: #E5E7EB;
            --text-secondary: #9CA3AF;
            --border: #374151;
            --border-light: #4B5563;
            --accent: #3B82F6;
            --accent-dim: #60A5FA;
            --highlight: #10B981;
            --selected: #3B82F6;
            
            --slot-alpha: #60A5FA;
            --slot-judgement: #F59E0B;
            --slot-interface: #10B981;
            --slot-lore: #8B5CF6;
            --slot-destiny: #EF4444;
            --slot-hybrid: #EC4899;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
        }
        
        .main-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .main-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            scrollbar-gutter: stable;
        }
        
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h1 {
            font-size: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .modal-body {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 60px);
        }
        
        .slots-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .totals-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            padding-right: 6px;
        }
        
        .totals-column::-webkit-scrollbar {
            width: 8px;
        }
        
        .totals-column::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        .totals-column::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .totals-column::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }
        
        .slot-panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .slot-panel.selected {
            border-left: 3px solid var(--slot-color);
        }
        
        .slot-panel.alpha.selected { --slot-color: var(--slot-alpha); }
        .slot-panel.judgement.selected { --slot-color: var(--slot-judgement); }
        .slot-panel.interface.selected { --slot-color: var(--slot-interface); }
        .slot-panel.lore.selected { --slot-color: var(--slot-lore); }
        .slot-panel.destiny.selected { --slot-color: var(--slot-destiny); }
        .slot-panel.hybrid.selected { --slot-color: var(--slot-hybrid); }
        
        .slot-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.2s;
            min-height: 50px;
        }
        
        .slot-header:hover {
            background: var(--bg-secondary);
        }
        
        .slot-info {
            display: flex;
            gap: 12px;
            align-items: center;
            flex: 1;
        }
        
        .expand-arrow {
            color: var(--text-secondary);
            font-size: 12px;
            transition: transform 0.2s;
            width: 16px;
            text-align: center;
        }
        
        .slot-panel.expanded .expand-arrow {
            transform: rotate(90deg);
        }
        
        .slot-name {
            font-weight: 600;
            font-size: 14px;
            min-width: 80px;
        }
        
        .slot-selection {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .slot-panel.selected .slot-selection {
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .slot-panel.selected .slot-selection:hover {
            color: #ff6b6b;
            text-decoration: underline;
        }
        
        .slot-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .slot-icon-circle {
            width: 48px;
            height: 48px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            background: var(--bg-primary);
            padding: 4px;
        }
        
        .slot-icon-circle:hover {
            border-color: var(--accent);
        }
        
        .slot-icon-circle.filled {
            border-color: var(--slot-color);
            background: var(--bg-secondary);
        }
        
        .slot-icon-circle img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .slot-content {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .slot-panel.collapsed .slot-content {
            display: none;
        }
        
        .slot-content .component-row {
            display: flex;
            align-items: center;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            border-left: 3px solid;
        }
        
        .slot-content .component-row:has(.component-common) {
            border-left-color: #FFFFFF;
        }
        
        .slot-content .component-row:has(.component-uncommon) {
            border-left-color: #ffe5a2;
        }
        
        .slot-content .component-row:has(.component-rare) {
            border-left-color: #FB923C;
        }
        
        .slot-content .component-row:has(.component-very-rare) {
            border-left-color: #A855F7;
        }
        
        .slot-content .component-name {
            font-size: 12px;
            font-weight: 500;
        }
        
        .slot-content .component-name.component-common {
            color: #FFFFFF;
        }
        
        .slot-content .component-name.component-uncommon {
            color: #ffe5a2;
        }
        
        .slot-content .component-name.component-rare {
            color: #FB923C;
        }
        
        .slot-content .component-name.component-very-rare {
            color: #A855F7;
        }
        
        .components-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .component-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .component-name {
            color: var(--text-primary);
        }
        
        .component-name.uncommon {
            color: #ffe5a2;
        }
        
        .component-name.rare {
            color: #EF4444;
        }
        
        .component-name.very-rare {
            color: #A855F7;
        }
        
        .component-qty {
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .resource-summary {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-top: 1px solid var(--border);
            margin-top: 8px;
            font-size: 13px;
        }
        
        .resource-summary:first-of-type {
            margin-top: 16px;
        }
        
        .resource-label {
            color: var(--text-secondary);
        }
        
        .resource-value {
            font-weight: 600;
        }
        
        .resource-value .dim {
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .threads { color: var(--accent-dim); }
        .merits-required { color: #EC4899; }
        .merits-total { color: #A855F7; }
        
        .totals-section {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: 6px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .totals-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-dim);
            margin-bottom: 0;
        }
        
        .tier-info-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 12px;
        }
        
        .tier-info-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .tier-info-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .tier-info-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .components-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 12px;
        }
        
        .components-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .hint {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .empty-icon {
            font-size: 24px;
            color: var(--border);
        }
        
        /* Selector Modal Styles */
        .selector-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .selector-modal-overlay.active {
            display: flex;
        }
        
        .selector-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            scrollbar-gutter: stable;
        }
        
        .selector-modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selector-modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }
        
        .selector-modal-body {
            padding: 20px;
            scrollbar-gutter: stable;
            display: grid;
            grid-template-columns: 1fr 380px;
            grid-template-rows: auto auto 1fr;
            gap: 20px;
            max-height: calc(90vh - 100px);
        }
        
        .selector-modal-body > .tree-selector {
            grid-column: 1;
            grid-row: 1;
        }
        
        .selector-modal-body > .tree-description {
            grid-column: 1;
            grid-row: 2;
        }
        
        .selector-modal-body > .tier-grid-container {
            grid-column: 1;
            grid-row: 3;
        }
        
        .tier-info {
            grid-column: 2;
            grid-row: 1 / -1;
            max-height: calc(90vh - 100px);
            overflow-y: scroll;
            scrollbar-gutter: stable;
        }
        
        .tree-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .tree-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 8px; /* Reduced horizontal padding */
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            overflow: hidden; /* Prevent overflow */
        }
        
        .tree-btn:hover {
            border-color: var(--accent-dim);
            background: var(--bg-secondary);
        }
        
        .tree-btn.selected {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }
        
        .tree-btn-name {
            font-weight: 600;
            font-size: 13px; /* Slightly smaller */
            word-wrap: break-word; /* Allow wrapping */
            line-height: 1.2;
        }
        
        .tree-btn-type {
            font-size: 10px; /* Slightly smaller */
            color: var(--text-secondary);
            margin-top: 4px;
            word-wrap: break-word; /* Allow wrapping */
            line-height: 1.2;
        }
        
        .tree-btn.selected .tree-btn-type {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .tree-description {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .tier-grid-container {
            position: relative;
            width: 100%;
            height: 450px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        
        .tier-grid {
            position: relative;
            width: 70%;
            height: 100%;
            margin: 0 auto;
        }
        
        .tier-node {
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--bg-tertiary);
            border: 3px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            transform: translate(-50%, -50%);
            padding: 10px;
        }
        
        .tier-node:hover {
            border-color: var(--accent-dim);
            background: var(--bg-secondary);
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 10;
        }
        
        .tier-node.selected {
            border-color: var(--selected);
            background: var(--selected);
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            z-index: 5;
            cursor: pointer; /* Show it's clickable */
        }
        
        .tier-node.selected:hover {
            border-color: #EF4444; /* Red on hover to indicate deselect */
            background: #EF4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        
        .tier-node.required {
            border-color: var(--highlight);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .tier-node.t4 {
            cursor: context-menu;
        }
        
        .tier-node-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0.4);
            transition: filter 0.2s;
        }
        
        .tier-node:hover .tier-node-icon,
        .tier-node.selected .tier-node-icon,
        .tier-node.required .tier-node-icon {
            filter: brightness(1);
        }
        
        .node-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            border: 1px solid var(--border);
        }
        
        .node-tooltip.show {
            opacity: 1;
        }
        
        .tier-info {
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow: hidden;
        }
        
        .tier-info-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .tier-info-subtitle {
            font-weight: 500;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .tier-info-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
            max-height: 80px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .tier-info-cost {
            padding: 8px 0;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .costs-two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 8px 0;
            border-top: 1px solid var(--border);
            margin-bottom: 8px;
        }
        
        .cost-column {
            display: flex;
            flex-direction: column;
        }
        
        .cost-header {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-dim);
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }
        
        .cost-display {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .tier-info-components {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .components-two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 8px;
        }

        .component-column {
            display: flex;
            flex-direction: column;
        }

        .tier-info-empyrean {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .component-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-dim);
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }
        
        .component-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 200%;
            overflow-y: auto;
        }
        
        .component-item {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .tier-info-hint {
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--accent-dim);
            font-style: italic;
            flex-shrink: 0;
        }
        
        .selector-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-cancel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .btn-cancel:hover {
            background: var(--bg-secondary);
        }
        
        .btn-select {
            background: var(--accent);
            border: 1px solid var(--accent);
            color: white;
        }
        
        .btn-select:hover {
            background: #2563EB;
        }
        
        .btn-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Component rarity colors */
        .component-common {
            color: #FFFFFF;
        }
        
        .component-uncommon {
            color: #ffe5a2;
        }
        
        .component-rare {
            color: #FB923C;
        }
        
        .component-very-rare {
            color: #A855F7;
        }
        
        .cost-threads {
            color: #FFFFFF;
        }
        
        .cost-empyrean {
            color: #C026D3;
        }

        /* Power Info Section */
        .power-info-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            max-height: 80px;
            overflow-y: auto;
        }

        .power-info-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .power-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .power-stat {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .power-stat-label {
            color: var(--text-secondary);
        }

        .power-stat-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .power-effects-list {
            margin-top: 8px;
        }

        .power-effect-item {
            font-size: 13px;
            padding: 4px 0;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .power-effect-item::before {
            content: 'â€¢ ';
            color: var(--selected);
            font-weight: bold;
        }

        .power-stat-highlight {
            color: #10B981;
            font-weight: 600;
        }

        .power-stat-change {
            color: #F59E0B;
            font-size: 11px;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <!-- Main Incarnate Modal -->
    <div class="main-modal-overlay">
        <div class="main-modal">
            <div class="modal-header">
                <h1>Incarnate Powers</h1>
                <button class="close-btn">Ã—</button>
            </div>
            
            <div class="modal-body">
                <!-- Left Column: Slots -->
                <div class="slots-column">
                    <!-- Hybrid Slot -->
                    <div class="slot-panel hybrid collapsed" data-slot="hybrid">
                        <div class="slot-header">
                            <div class="slot-info">
                                <span class="expand-arrow">â–¶</span>
                                <div class="slot-name">Hybrid</div>
                                <div class="slot-selection">-</div>
                            </div>
                            <div class="slot-actions">
                                <div class="slot-icon-circle" title="Click to select power">
                                    <span class="empty-icon">+</span>
                                </div>
                            </div>
                        </div>
                        <div class="slot-content"></div>
                    </div>
                    
                    <!-- Destiny Slot -->
                    <div class="slot-panel destiny collapsed" data-slot="destiny">
                        <div class="slot-header">
                            <div class="slot-info">
                                <span class="expand-arrow">â–¶</span>
                                <div class="slot-name">Destiny</div>
                                <div class="slot-selection">-</div>
                            </div>
                            <div class="slot-actions">
                                <div class="slot-icon-circle" title="Click to select power">
                                    <span class="empty-icon">+</span>
                                </div>
                            </div>
                        </div>
                        <div class="slot-content"></div>
                    </div>
                    
                    <!-- Lore Slot -->
                    <div class="slot-panel lore collapsed" data-slot="lore">
                        <div class="slot-header">
                            <div class="slot-info">
                                <span class="expand-arrow">â–¶</span>
                                <div class="slot-name">Lore</div>
                                <div class="slot-selection">-</div>
                            </div>
                            <div class="slot-actions">
                                <div class="slot-icon-circle" title="Click to select power">
                                    <span class="empty-icon">+</span>
                                </div>
                            </div>
                        </div>
                        <div class="slot-content"></div>
                    </div>
                    
                    <!-- Interface Slot -->
                    <div class="slot-panel interface collapsed" data-slot="interface">
                        <div class="slot-header">
                            <div class="slot-info">
                                <span class="expand-arrow">â–¶</span>
                                <div class="slot-name">Interface</div>
                                <div class="slot-selection">-</div>
                            </div>
                            <div class="slot-actions">
                                <div class="slot-icon-circle" title="Click to select power">
                                    <span class="empty-icon">+</span>
                                </div>
                            </div>
                        </div>
                        <div class="slot-content"></div>
                    </div>
                    
                    <!-- Judgement Slot -->
                    <div class="slot-panel judgement collapsed" data-slot="judgement">
                        <div class="slot-header">
                            <div class="slot-info">
                                <span class="expand-arrow">â–¶</span>
                                <div class="slot-name">Judgement</div>
                                <div class="slot-selection">-</div>
                            </div>
                            <div class="slot-actions">
                                <div class="slot-icon-circle" title="Click to select power">
                                    <span class="empty-icon">+</span>
                                </div>
                            </div>
                        </div>
                        <div class="slot-content"></div>
                    </div>
                    
                    <!-- Alpha Slot -->
                    <div class="slot-panel alpha collapsed" data-slot="alpha">
                        <div class="slot-header">
                            <div class="slot-info">
                                <span class="expand-arrow">â–¶</span>
                                <div class="slot-name">Alpha</div>
                                <div class="slot-selection">-</div>
                            </div>
                            <div class="slot-actions">
                                <div class="slot-icon-circle" title="Click to select power">
                                    <span class="empty-icon">+</span>
                                </div>
                            </div>
                        </div>
                        <div class="slot-content"></div>
                    </div>
                </div>
                
                <!-- Right Column: Info Panel -->
                <div class="totals-column">
                    <div class="totals-section">
                        <div class="totals-title">Power Summary</div>
                        <div id="mainTierInfo" class="tier-info-section">
                            <div class="tier-info-title">Select a slot to view details</div>
                            <div class="tier-info-desc">Click any slot icon to choose an incarnate power</div>
                        </div>
                        
                        <div class="components-section">
                            <div class="components-title">Required Components</div>
                            <div class="components-list" id="totalComponentsList">
                                <div class="component-row">
                                    <span class="component-name">No powers selected</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="resource-summary">
                            <span class="resource-label">Incarnate Threads</span>
                            <span class="resource-value" id="totalThreads">
                                <span class="cost-threads">0</span>
                            </span>
                        </div>
                        <div class="resource-summary">
                            <span class="resource-label">Empyrean Merits</span>
                            <span class="resource-value" id="totalEmp">
                                <span class="cost-empyrean">0 (0)</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Selector Modal (hidden by default) -->
    <div class="selector-modal-overlay" id="selectorModal">
        <div class="selector-modal">
            <div class="selector-modal-header">
                <h2 id="selectorTitle">Select Judgement Power</h2>
                <button class="close-btn" onclick="closeSelectorModal()">Ã—</button>
            </div>
            
            <div class="selector-modal-body">
                <div class="tree-selector" id="treeSelector">
                    <!-- Tree buttons will be generated by JS -->
                </div>
                
                <div class="tree-description" id="treeDescription">
                    Select a tree above to see available powers
                </div>
                
                <div class="tier-grid-container">
                    <div class="tier-grid" id="tierGrid">
                        <!-- Tier nodes will be positioned via JS -->
                    </div>
                    <div class="node-tooltip" id="nodeTooltip"></div>
                </div>
                
                <div class="tier-info" id="tierInfo">
                    <div class="tier-info-title">Hover or click a node to see details</div>
                    <div class="tier-info-desc">
                        Click any tier node to select that power. Prerequisites will automatically highlight.
                    </div>
                    <div class="tier-info-hint">
                        ðŸ’¡ Right-click T4 nodes to cycle through different T3 prerequisite combinations
                    </div>
                </div>
            </div>
            
            <div class="selector-modal-footer">
                <button class="btn btn-cancel" onclick="closeSelectorModal()">Cancel</button>
                <button class="btn btn-select" id="selectBtn" onclick="confirmSelection()" disabled>Select Power</button>
            </div>
        </div>
    </div>
    
    <script src="../js/incarnate-data.js"></script>
    <script src="../js/incarnate-components.js"></script>
    <script src="../js/incarnate-component-helper.js?v=3"></script>
    <script src="../js/incarnate-power-info.js"></script>
    <script src="../js/incarnate-recipes.js"></script>
    <script>
        // Verify IncarnatePowerInfo loaded
        console.log('=== Script Load Verification ===');
        console.log('IncarnatePowerInfo loaded:', typeof IncarnatePowerInfo !== 'undefined');
        if (typeof IncarnatePowerInfo !== 'undefined') {
            console.log('IncarnatePowerInfo slots:', Object.keys(IncarnatePowerInfo));
            console.log('judgement slot:', IncarnatePowerInfo.judgement);
            console.log('Cryonic tree:', IncarnatePowerInfo.judgement?.cryonic);
            console.log('t1 tier:', IncarnatePowerInfo.judgement?.cryonic?.t1);
        }
        
        // Current slot being edited
let currentSlot = null;
let selectedNode = null;
let selectedTree = null;
let currentTreeData = null;

// Grid configuration
const GRID_CONFIG = {
    cols: 5,
    rows: 4,
    nodes: {
        t4_core: [1, 1],
        t4_radial: [5, 1],
        t3_core_1: [1, 2],
        t3_core_2: [2, 2],
        t3_radial_1: [4, 2],
        t3_radial_2: [5, 2],
        t2_core: [2, 3],
        t2_radial: [4, 3],
        t1: [3, 4]
    }
};

// T4 combination tracking
const t4CombinationIndex = {
    t4_core: 0,
    t4_radial: 0
};

// T4 prerequisite combinations
const T4_COMBINATIONS = {
    t4_core: [
        ['t3_core_1', 't3_radial_1'],
        ['t3_core_1', 't3_radial_2'],
        ['t3_core_2', 't3_radial_1'],
        ['t3_core_2', 't3_radial_2']
    ],
    t4_radial: [
        ['t3_core_1', 't3_radial_1'],
        ['t3_core_1', 't3_radial_2'],
        ['t3_core_2', 't3_radial_1'],
        ['t3_core_2', 't3_radial_2']
    ]
};

// Track selected powers
const selectedPowers = {
    alpha: null,
    judgement: null,
    interface: null,
    lore: null,
    destiny: null,
    hybrid: null
};

// Track last selections per slot (for reopening modal)
const lastSelections = {
    alpha: null,
    judgement: null,
    interface: null,
    lore: null,
    destiny: null,
    hybrid: null
};

// Calculate total costs across all selected powers (including full crafting path)
function calculateTotalCosts() {
    let totalThreads = 0;
    let totalEmpRequired = 0;
    
    Object.entries(selectedPowers).forEach(([slot, selection]) => {
        if (!selection) return;
        
        // Calculate costs for entire crafting path
        const pathCosts = getCostsForPath(selection.nodeId);
        totalThreads += pathCosts.threads;
        totalEmpRequired += pathCosts.empyrean;
    });
    
    // Calculate total Empyrean if converting all threads to merits
    // 1 Empyrean Merit = 20 Threads
    const totalEmpFromThreads = Math.floor(totalThreads / 20);
    const totalEmpCombined = totalEmpRequired + totalEmpFromThreads;
    
    console.log(`calculateTotalCosts: threads=${totalThreads}, empRequired=${totalEmpRequired}, empFromThreads=${totalEmpFromThreads}, total=${totalEmpCombined}`);
    
    return {
        threads: totalThreads,
        empRequired: totalEmpRequired,
        empTotal: totalEmpCombined
    };
}

// Get cost for just the current node (not the full path)
function getNodeOnlyCost(nodeId) {
    const comps = getComponentsForNode(currentSlot, selectedTree, nodeId);
    console.log(`getNodeOnlyCost(${nodeId}): comps =`, comps);
    if (comps && comps.salvage) {
        const cost = calculateComponentsCost(comps.salvage);
        console.log(`  salvage=[${comps.salvage.join(', ')}], cost=`, cost);
        return cost;
    }
    return { threads: 0, empyrean: 0 };
}

// Get costs for entire crafting path based on actual components
function getCostsForPath(finalNodeId) {
    // For T4 nodes, each tier requires multiple copies of previous tiers
    // because each upgrade consumes the previous version
    
    if (finalNodeId === 't4_core' || finalNodeId === 't4_radial') {
        // T4 requires BOTH core and radial paths
        // Path: 2x T1 + 2x T2_core + 2x T2_radial + 2x T3_core + 2x T3_radial + 1x T4
        
        // Get the currently selected T3 combination
        const combinationIndex = t4CombinationIndex[finalNodeId] || 0;
        const combinations = T4_COMBINATIONS[finalNodeId];
        const selectedCombination = combinations ? combinations[combinationIndex] : ['t3_core_1', 't3_radial_1'];
        const [t3Core, t3Radial] = selectedCombination;
        
        const pathNodeIds = [
            't1', 't1',           // 2x T1
            't2_core', 't2_radial',  // 1 each of T2 (core and radial)
            t3Core, t3Radial,     // 1 each of T3 (selected combination)
            finalNodeId           // 1x T4
        ];
        
        let totalThreads = 0;
        let totalEmpyrean = 0;
        
        console.log(`getCostsForPath(${finalNodeId}): combination=[${t3Core}, ${t3Radial}], pathNodeIds=[${pathNodeIds.join(', ')}]`);
        
        pathNodeIds.forEach((nodeId, index) => {
            const comps = getComponentsForNode(currentSlot, selectedTree, nodeId);
            if (comps && comps.salvage) {
                const cost = calculateComponentsCost(comps.salvage);
                console.log(`  [${index}] ${nodeId}: salvage=[${comps.salvage.join(', ')}], cost={threads:${cost.threads}, emp:${cost.empyrean}}`);
                totalThreads += cost.threads;
                totalEmpyrean += cost.empyrean;
            } else {
                console.log(`  [${index}] ${nodeId}: NO COMPONENTS FOUND`);
            }
        });
        
        console.log(`getCostsForPath final: {threads:${totalThreads}, empyrean:${totalEmpyrean}}`);
        
        return {
            threads: totalThreads,
            empyrean: totalEmpyrean
        };
    }
    
    // For non-T4 nodes, use fixed paths with single copies
    const pathMap = {
        't1': ['t1'],
        't2_core': ['t1', 't2_core'],
        't2_radial': ['t1', 't2_radial'],
        't3_core_1': ['t1', 't2_core', 't3_core_1'],
        't3_core_2': ['t1', 't2_core', 't3_core_2'],
        't3_radial_1': ['t1', 't2_radial', 't3_radial_1'],
        't3_radial_2': ['t1', 't2_radial', 't3_radial_2']
    };
    
    const nodeIds = pathMap[finalNodeId] || [];
    let totalThreads = 0;
    let totalEmpyrean = 0;
    
    console.log(`getCostsForPath(${finalNodeId}): nodeIds=[${nodeIds.join(', ')}]`);
    
    nodeIds.forEach(nodeId => {
        const comps = getComponentsForNode(currentSlot, selectedTree, nodeId);
        if (comps && comps.salvage) {
            const cost = calculateComponentsCost(comps.salvage);
            console.log(`  ${nodeId}: salvage=[${comps.salvage.join(', ')}], cost={threads:${cost.threads}, emp:${cost.empyrean}}`);
            totalThreads += cost.threads;
            totalEmpyrean += cost.empyrean;
        } else {
            console.log(`  ${nodeId}: NO COMPONENTS FOUND`);
        }
    });
    
    console.log(`getCostsForPath final: {threads:${totalThreads}, empyrean:${totalEmpyrean}}`);
    
    return {
        threads: totalThreads,
        empyrean: totalEmpyrean
    };
}

// Update the totals display
function updateTotalsDisplay() {
    const costs = calculateTotalCosts();
    
    // Update threads display
    const threadsEl = document.getElementById('totalThreads');
    if (threadsEl) {
        threadsEl.innerHTML = `<span class="cost-threads">${costs.threads}</span>`;
    }
    
    // Update empyrean display
    const empEl = document.getElementById('totalEmp');
    if (empEl) {
        empEl.innerHTML = `<span class="cost-empyrean">${costs.empRequired} (${costs.empTotal})</span>`;
    }
    
    // Update components list
    updateComponentsList();
}

// Get all components needed for entire crafting path
function getAllComponentsForPath(slot, tree, nodeId) {
    const allComponents = [];
    
    // For T4 nodes, use the specific combination selected
    if (nodeId === 't4_core' || nodeId === 't4_radial') {
        const combinationIndex = t4CombinationIndex[nodeId] || 0;
        const combinations = T4_COMBINATIONS[nodeId];
        const selectedCombination = combinations ? combinations[combinationIndex] : ['t3_core_1', 't3_radial_1'];
        const [t3Core, t3Radial] = selectedCombination;
        
        const pathNodeIds = [
            't1', 't1',           // 2x T1
            't2_core', 't2_radial',  // 1 each of T2 (core and radial)
            t3Core, t3Radial,     // 1 each of T3 (selected combination)
            nodeId                // 1x T4
        ];
        
        pathNodeIds.forEach(nid => {
            const comps = getComponentsForNode(slot, tree, nid);
            if (comps && comps.salvage) {
                allComponents.push(...comps.salvage);
            }
        });
        
        return allComponents;
    }
    
    // For non-T4 nodes, use fixed paths
    const pathMap = {
        't1': ['t1'],
        't2_core': ['t1', 't2_core'],
        't2_radial': ['t1', 't2_radial'],
        't3_core_1': ['t1', 't2_core', 't3_core_1'],
        't3_core_2': ['t1', 't2_core', 't3_core_2'],
        't3_radial_1': ['t1', 't2_radial', 't3_radial_1'],
        't3_radial_2': ['t1', 't2_radial', 't3_radial_2']
    };
    
    const nodeIds = pathMap[nodeId] || [];
    nodeIds.forEach(nid => {
        const comps = getComponentsForNode(slot, tree, nid);
        if (comps && comps.salvage) {
            allComponents.push(...comps.salvage);
        }
    });
    
    return allComponents;
}

// Consolidate components by name, sort by rarity then alphabetically
function consolidateAndSortComponents(components) {
    // Group components by name and count quantities
    const componentMap = {};
    
    components.forEach(compStr => {
        // Parse quantity and name (format: "1x ComponentName" or just "ComponentName")
        const match = compStr.match(/^(\d+)x\s+(.+)$/) || compStr.match(/^(.+)$/);
        const quantity = match[1] && !isNaN(match[1]) ? parseInt(match[1]) : 1;
        const name = match[2] || match[1];
        
        if (componentMap[name]) {
            componentMap[name] += quantity;
        } else {
            componentMap[name] = quantity;
        }
    });
    
    // Define rarity order (lower number = lower rarity)
    const rarityMap = {
        'common': 0,
        'uncommon': 1,
        'rare': 2,
        'very-rare': 3
    };
    
    // Sort by rarity (ascending) then alphabetically
    const sorted = Object.entries(componentMap).sort((a, b) => {
        const rarityA = rarityMap[getComponentRarity(a[0])] || 0;
        const rarityB = rarityMap[getComponentRarity(b[0])] || 0;
        
        if (rarityA !== rarityB) {
            return rarityA - rarityB;
        }
        return a[0].localeCompare(b[0]);
    });
    
    // Format as strings with quantities
    return sorted.map(([name, qty]) => qty > 1 ? `${qty}x ${name}` : name);
}

// Helper to find node ID from power name
function findNodeIdByName(powerName) {
    // Map power names to node IDs
    // The prerequisite names follow patterns like "PowerName_Boost", "PowerName_Core_Boost", etc.
    
    if (powerName.includes('_Boost') && !powerName.includes('Core') && !powerName.includes('Radial')) {
        return 't1';
    }
    if (powerName.includes('_Core_Boost') || powerName.includes('_Core_Judgement') || 
        powerName.includes('_Core_Interface') || powerName.includes('_Core_Ally') || 
        powerName.includes('_Core_Invocation') || powerName.includes('_Core_Genome')) {
        return 't2_core';
    }
    if (powerName.includes('_Radial_Boost') || powerName.includes('_Radial_Judgement') || 
        powerName.includes('_Radial_Interface') || powerName.includes('_Radial_Ally') || 
        powerName.includes('_Radial_Invocation') || powerName.includes('_Radial_Genome')) {
        return 't2_radial';
    }
    if (powerName.includes('_Total_Core')) {
        return 't3_core_1';
    }
    if (powerName.includes('_Partial_Core')) {
        return 't3_core_2';
    }
    if (powerName.includes('_Total_Radial')) {
        return 't3_radial_1';
    }
    if (powerName.includes('_Partial_Radial')) {
        return 't3_radial_2';
    }
    
    return null;
}

// Update the detailed components list
function updateComponentsList() {
    const listEl = document.getElementById('totalComponentsList');
    if (!listEl) return;
    
    // Collect all components from selected powers (full crafting paths)
    const allComponents = {};
    
    Object.entries(selectedPowers).forEach(([slot, selection]) => {
        if (!selection) return;
        
        // Get ALL components for the entire crafting path
        const pathComponents = getAllComponentsForPath(slot, selection.tree, selection.nodeId);
        
        pathComponents.forEach(salvageStr => {
            // Parse "1x ComponentName" format
            const match = salvageStr.match(/(\d+)x\s+(.+)/);
            if (match) {
                const qty = parseInt(match[1]);
                const name = match[2];
                
                if (!allComponents[name]) {
                    allComponents[name] = {
                        quantity: 0,
                        rarity: getComponentRarity(name)
                    };
                }
                allComponents[name].quantity += qty;
            }
        });
    });
    
    // Display components
    if (Object.keys(allComponents).length === 0) {
        listEl.innerHTML = `
            <div class="component-row">
                <span class="component-name">No powers selected</span>
            </div>
        `;
        return;
    }
    
    // Sort by rarity (common -> uncommon -> rare -> very rare)
    const rarityOrder = { 'common': 1, 'uncommon': 2, 'rare': 3, 'very-rare': 4 };
    const sortedComponents = Object.entries(allComponents).sort((a, b) => {
        return rarityOrder[a[1].rarity] - rarityOrder[b[1].rarity];
    });
    
    listEl.innerHTML = sortedComponents.map(([name, data]) => {
        return `
            <div class="component-row">
                <span class="component-name component-${data.rarity}">${data.quantity}x ${name}</span>
            </div>
        `;
    }).join('');
}

// Component data - fetched dynamically per node
// Note: getComponentsForNode is defined in incarnate-component-helper.js
// This is a wrapper that uses currentSlot and selectedTree context
function getComponentsForNodeInContext(nodeId) {
    if (!currentSlot || !selectedTree) return [];
    
    // Call the helper function from incarnate-component-helper.js
    return getFormattedComponents(currentSlot, selectedTree, nodeId);
}

// Get power information for a node
function getPowerInfo(slot, tree, nodeId) {
    // Check if IncarnatePowerInfo is defined (may not be in window scope)
    const powerData = typeof IncarnatePowerInfo !== 'undefined' ? IncarnatePowerInfo : window.IncarnatePowerInfo;
    
    if (!powerData) {
        console.log('IncarnatePowerInfo not available');
        return null;
    }
    
    const slotKey = slot ? slot.toLowerCase() : '';
    console.log('getPowerInfo - slot:', slot, 'tree:', tree, 'nodeId:', nodeId);
    
    const slotData = powerData[slotKey];
    console.log('slotData:', slotData);
    
    if (!slotData || Object.keys(slotData).length === 0) {
        console.log('No slot data for:', slotKey);
        return null;
    }
    
    // Use the same mapping function for tree keys
    const treeKey = getTreeDataKey(slot, tree);
    
    if (!slotData[treeKey]) {
        console.log('No tree data for:', treeKey, 'available trees:', Object.keys(slotData));
        return null;
    }
    
    const treeData = slotData[treeKey];
    console.log('treeData:', treeData);
    console.log('Looking for tier:', nodeId, 'in tiers:', Object.keys(treeData || {}));
    
    if (!treeData || !treeData[nodeId]) {
        console.log('No tier data for:', nodeId);
        return null;
    }
    
    const tierData = treeData[nodeId];
    console.log('tierData found:', tierData);
    
    return tierData;
}

// Map IncarnateData tree names to IncarnatePowerInfo keys (especially for Lore)
function getTreeDataKey(slot, treeName) {
    if (slot !== 'lore') {
        // For non-lore slots, just use lowercase
        return treeName.toLowerCase().replace(/\s+/g, '_');
    }
    
    // For Lore, map the tree display names to power data keys
    const loreMapping = {
        'Arachnos': 'arachnos',
        'Banished': 'banished_pantheon',
        'Banished Pantheon': 'banished_pantheon',
        'Carnival': 'carnival',
        'Carnival of Shadows': 'carnival',
        'Cimeroran': 'cimeroran',
        'Clockwork': 'clockwork',
        'Drones': 'robotic_drones',
        'Robotic Drones': 'robotic_drones',
        'Elementals': 'storm_elemental',
        'IDF': 'idf',
        'Knives': 'knives_of_vengeance',
        'Knives of Artemis': 'knives_of_vengeance',
        'Lights': 'polar_lights',
        'Polar Lights': 'polar_lights',
        'Longbow': 'longbow',
        'Nemesis': 'nemesis',
        'Phantoms': 'phantom',
        'Rikti': 'rikti',
        'Rularuu': 'rularuu',
        'Seers': 'seers',
        'Talons': 'talons_of_vengeance',
        'Talons of Vengeance': 'talons_of_vengeance',
        'Tsoo': 'tsoo',
        'Vanguard': 'vanguard',
        'WarWorks': 'warworks',
        'Praetorian Clockwork': 'warworks'
    };
    
    return loreMapping[treeName] || treeName.toLowerCase().replace(/\s+/g, '_');
}

// Build nodes from tree data
function buildNodesFromTreeData(treeName) {
    // Get the correct tree key for this slot/tree combination
    const treeKey = getTreeDataKey(currentSlot, treeName);
    
    // Get power data from IncarnatePowerInfo (check both window and global)
    const powerData = typeof IncarnatePowerInfo !== 'undefined' ? IncarnatePowerInfo : window.IncarnatePowerInfo;
    if (!powerData) {
        console.error('IncarnatePowerInfo not available');
        return {};
    }
    
    const slotKey = currentSlot.toLowerCase();
    const slotData = powerData[slotKey];
    
    if (!slotData) {
        console.error('No power data for slot:', slotKey);
        return {};
    }
    
    // Look for power entries matching this tree (could be base name or with variants)
    let treeData = slotData[treeKey];
    
    // If not found, try to find a matching tree with variants
    if (!treeData) {
        const matchingKeys = Object.keys(slotData).filter(key => 
            key === treeKey || key.startsWith(treeKey + '_')
        );
        
        if (matchingKeys.length === 0) {
            console.error('No power data for tree:', treeName, 'with key:', treeKey, 'available keys:', Object.keys(slotData));
            return {};
        }
        
        // Use the first matching key (usually the base)
        treeData = slotData[matchingKeys[0]];
    }
    
    if (!treeData || Object.keys(treeData).length === 0) {
        console.error('No tier data for tree:', treeName);
        return {};
    }
    
    console.log('treeData found for:', treeKey, 'available tiers:', Object.keys(treeData));
    
    const nodes = {};
    
    // Define tier order
    const tierOrder = ['t1', 't2_core', 't2_radial', 't3_core_1', 't3_core_2', 't3_radial_1', 't3_radial_2', 't4_core', 't4_radial'];
    
    // Build nodes for each tier that exists in the data
    tierOrder.forEach((tierId, index) => {
        if (treeData[tierId]) {
            const tierPowerData = treeData[tierId];
            const tier = index < 1 ? 1 : index < 3 ? 2 : index < 7 ? 3 : 4;
            
            // For T4 nodes, get prerequisites from current combination index
            let requires = getTierRequirements(tierId);
            if ((tierId === 't4_core' || tierId === 't4_radial') && T4_COMBINATIONS[tierId]) {
                const combos = T4_COMBINATIONS[tierId];
                const currentIndex = t4CombinationIndex[tierId] || 0;
                requires = combos[currentIndex] || requires;
            }
            
            // Build tier name (e.g., "Tier 1", "Tier 2 Core", "Tier 4 Radial")
            let tierName = 'Tier ' + tier;
            if (tierId.includes('core')) {
                tierName += ' Core';
            } else if (tierId.includes('radial')) {
                tierName += ' Radial';
            }
            
            // Get the actual power name from the game (e.g., "Agility Total Core Revamp")
            const actualPowerName = getActualPowerName(treeName, tierId);
            
            // Build full name including slot and actual power name
            const slotDisplay = currentSlot.charAt(0).toUpperCase() + currentSlot.slice(1);
            const fullName = `${slotDisplay} - ${actualPowerName}`;
            
            nodes[tierId] = {
                id: tierId,
                tier: tier,
                variant: tierId.includes('core') ? 'core' : tierId.includes('radial') ? 'radial' : null,
                name: treeName, // Use display name from UI
                fullName: fullName, // Full name with slot and actual power name
                tierName: tierName, // Generic tier name for reference
                actualPowerName: actualPowerName, // Actual power name from the game
                desc: tierPowerData.desc || '',
                cost: getThreadCost(tier) + ' Threads',
                requires: requires
            };
        }
    });
    
    return nodes;
}

// Map tier IDs to their corresponding power name suffixes
function getTierSuffix(tierId) {
    const suffixMap = {
        't1': 'Boost',
        't2_core': 'Core Boost',
        't2_radial': 'Radial Boost',
        't3_core_1': 'Core Paragon',
        't3_core_2': 'Partial Core Revamp',
        't3_radial_1': 'Radial Paragon',
        't3_radial_2': 'Partial Radial Revamp',
        't4_core': 'Total Core Revamp',
        't4_radial': 'Total Radial Revamp'
    };
    return suffixMap[tierId] || 'Unknown';
}

// Build the actual power name (e.g., "Agility Total Core Revamp")
function getActualPowerName(treeName, tierId) {
    const suffix = getTierSuffix(tierId);
    return `${treeName} ${suffix}`;
}

function getTierRequirements(tierId) {
    // For T4 nodes, return their specific prerequisites based on combination
    if (tierId === 't4_core' || tierId === 't4_radial') {
        // Only look up dynamic requirements if currentTreeData has been built
        if (currentTreeData && currentTreeData[tierId]) {
            const node = currentTreeData[tierId];
            if (node && node.requires) {
                return node.requires;
            }
        }
        // Default T4 prerequisites
        return ['t3_core_1', 't3_radial_1'];
    }
    
    const requirements = {
        't1': [],
        't2_core': ['t1'],
        't2_radial': ['t1'],
        't3_core_1': ['t2_core'],
        't3_core_2': ['t2_core'],
        't3_radial_1': ['t2_radial'],
        't3_radial_2': ['t2_radial']
    };
    return requirements[tierId] || [];
}
        
        // Main modal - slot header expand/collapse
        // Main modal - slot header expand/collapse
        document.querySelectorAll('.slot-header').forEach(header => {
            header.addEventListener('click', (e) => {
                // Don't toggle if clicking the icon circle
                if (e.target.closest('.slot-icon-circle')) {
                    return;
                }
                
                const panel = header.closest('.slot-panel');
                
                // Toggle expansion
                if (panel.classList.contains('collapsed')) {
                    panel.classList.remove('collapsed');
                    panel.classList.add('expanded');
                } else {
                    panel.classList.remove('expanded');
                    panel.classList.add('collapsed');
                }
            });
        });
        
        // Main modal - open selector modal
        document.querySelectorAll('.slot-icon-circle').forEach(circle => {
            circle.addEventListener('click', (e) => {
                e.stopPropagation();
                const slot = circle.closest('.slot-panel').dataset.slot;
                openSelectorModal(slot);
            });
        });

        // Add click listener to slot-selection text to deselect power
        document.querySelectorAll('.slot-selection').forEach(selection => {
            selection.addEventListener('click', (e) => {
                e.stopPropagation();
                const panel = selection.closest('.slot-panel');
                const slot = panel.dataset.slot;
                
                // Only allow deselection if a power is selected
                if (selection.textContent !== '-') {
                    clearSlotSelection(slot);
                }
            });
        });

// Open selector modal
function openSelectorModal(slot) {
    currentSlot = slot;
    selectedNode = null;
    
    const slotData = IncarnateData[slot];
    if (!slotData) {
        console.error('No data for slot:', slot);
        return;
    }
    
    // Get first tree as default
    const treeNames = Object.keys(slotData.trees);
    selectedTree = treeNames[0];
    
    document.getElementById('selectorTitle').textContent = `Select ${slotData.slotName} Power`;
    document.getElementById('selectorModal').classList.add('active');
    
    renderTreeSelector();
    renderTierGrid();
    
    // Restore previous selection if available
    if (lastSelections[slot]) {
        const lastSel = lastSelections[slot];
        selectedTree = lastSel.tree;
        selectedNode = lastSel.nodeId;
        
        // Re-render to show the restored selection
        renderTreeSelector();
        renderTierGrid();
        
        // Update node states to highlight the selected node
        updateNodeStates();
        showNodeInfo(selectedNode);
        
        // Update select button
        const node = currentTreeData[selectedNode];
        if (node) {
            document.getElementById('selectBtn').disabled = false;
            document.getElementById('selectBtn').textContent = `Select: ${node.name}`;
        }
    }
}
        
// Close selector modal
function closeSelectorModal() {
    // Save current selection for reopening
    if (selectedNode && currentSlot) {
        lastSelections[currentSlot] = {
            nodeId: selectedNode,
            tree: selectedTree
        };
    }
    document.getElementById('selectorModal').classList.remove('active');
}

// Render tree selector
function renderTreeSelector() {
    const container = document.getElementById('treeSelector');
    const slotData = IncarnateData[currentSlot];
    const trees = Object.keys(slotData.trees);
    
    container.innerHTML = trees.map(treeName => {
        const tree = slotData.trees[treeName];
        // Insert word-break opportunities after forward slashes for better text wrapping
        const nameWithBreaks = tree.name.replace(/\//g, '/<wbr>');
        const typeWithBreaks = tree.type.replace(/\//g, '/<wbr>');
        return `
            <div class="tree-btn ${treeName === selectedTree ? 'selected' : ''}" onclick="selectTree('${treeName}')">
                <div class="tree-btn-name">${nameWithBreaks}</div>
                <div class="tree-btn-type">${typeWithBreaks}</div>
            </div>
        `;
    }).join('');
    
    // Update description
    const selectedTreeData = slotData.trees[selectedTree];
    document.getElementById('treeDescription').textContent = selectedTreeData.description;
}

function selectTree(treeName) {
    selectedTree = treeName;
    selectedNode = null; // Clear selection when changing trees
    
    // Reset T4 combination indices
    t4CombinationIndex.t4_core = 0;
    t4CombinationIndex.t4_radial = 0;
    
    renderTreeSelector();
    renderTierGrid();
    
    // Reset button state
    document.getElementById('selectBtn').disabled = true;
    document.getElementById('selectBtn').textContent = 'Select Power';
}

// Render tier grid
function renderTierGrid() {
    const grid = document.getElementById('tierGrid');
    grid.innerHTML = '';
    
    // Build nodes from current tree data
    const nodes = buildNodesFromTreeData(selectedTree);
    currentTreeData = nodes;
    
    Object.entries(nodes).forEach(([key, node]) => {
        const pos = GRID_CONFIG.nodes[key];
        if (!pos) return;
        
        const { x, y } = getNodePosition(pos[0], pos[1]);
        
        const nodeEl = document.createElement('div');
        nodeEl.className = `tier-node ${node.tier === 4 ? 't4' : ''}`;
        nodeEl.dataset.nodeId = key;
        nodeEl.style.left = x + 'px';
        nodeEl.style.top = y + 'px';
        
        const icon = document.createElement('img');
        icon.className = 'tier-node-icon';
        icon.src = getIconPath(key);
        nodeEl.appendChild(icon);
        
        nodeEl.addEventListener('click', () => selectNode(key));
        
        if (node.tier === 4) {
            nodeEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                cycleT4Combination(key);
            });
        }
        
        nodeEl.addEventListener('mouseenter', (e) => {
            // Only show info on hover if no node is selected
            if (!selectedNode) {
                showNodeInfo(key);
            }
            showTooltip(e, node.fullName);
        });
        nodeEl.addEventListener('mouseleave', () => {
            // Only hide info if no node is selected
            if (!selectedNode) {
                hideNodeInfo();
            }
            hideTooltip();
        });
        nodeEl.addEventListener('mousemove', updateTooltipPosition);
        
        grid.appendChild(nodeEl);
    });
}
        
        function getNodePosition(col, row) {
            const container = document.getElementById('tierGrid');
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            
            const x = (width / (GRID_CONFIG.cols + 1)) * col;
            const y = (height / (GRID_CONFIG.rows + 1)) * row;
            
            return { x, y };
        }

function getIconPath(nodeId) {
    const node = currentTreeData[nodeId];
    const tierNames = ['Common', 'Uncommon', 'Rare', 'VeryRare'];
    const tierName = tierNames[node.tier - 1];
    
    // Capitalize slot name for icon path
    const slotName = currentSlot.charAt(0).toUpperCase() + currentSlot.slice(1);
    
    return `../img/Incarnate/Incarnate_${slotName}_${selectedTree}_${tierName}.png`;
}

function selectNode(nodeId) {
    // If clicking the already selected node, deselect it
    if (selectedNode === nodeId) {
        selectedNode = null;
        updateNodeStates();
        hideNodeInfo();
        
        document.getElementById('selectBtn').disabled = true;
        document.getElementById('selectBtn').textContent = 'Select Power';
        return;
    }
    
    // Otherwise, select the new node
    selectedNode = nodeId;
    updateNodeStates();
    showNodeInfo(nodeId);
    
    document.getElementById('selectBtn').disabled = false;
    document.getElementById('selectBtn').textContent = `Select: ${currentTreeData[nodeId].name}`;
}
        
        function updateNodeStates() {
            document.querySelectorAll('.tier-node').forEach(el => {
                el.classList.remove('selected', 'required');
            });
            
            if (!selectedNode) return;
            
            const selectedEl = document.querySelector(`[data-node-id="${selectedNode}"]`);
            if (selectedEl) selectedEl.classList.add('selected');
            
            const required = getRequiredNodes(selectedNode);
            required.forEach(nodeId => {
                const el = document.querySelector(`[data-node-id="${nodeId}"]`);
                if (el) el.classList.add('required');
            });
        }

function getRequiredNodes(nodeId, collected = new Set()) {
    const node = currentTreeData[nodeId];
    if (!node) return collected;
    
    const requires = node.requires;
    if (!requires) return collected;
    
    requires.forEach(reqId => {
        if (!collected.has(reqId)) {
            collected.add(reqId);
            getRequiredNodes(reqId, collected);
        }
    });
    
    return collected;
}

function getCombinationLabel(nodeId) {
    const node = currentTreeData[nodeId];
    const combination = node.requires;
    if (!combination || combination.length !== 2) return '';
    
    const coreNum = combination[0].match(/\d+$/)[0];
    const radialNum = combination[1].match(/\d+$/)[0];
    
    return `C${coreNum}+R${radialNum}`;
}

function cycleT4Combination(nodeId) {
    const combinations = T4_COMBINATIONS[nodeId];
    if (!combinations) return;
    
    t4CombinationIndex[nodeId] = (t4CombinationIndex[nodeId] + 1) % combinations.length;
    renderTierGrid();
    
    if (selectedNode === nodeId) {
        updateNodeStates();
        showNodeInfo(nodeId);
    }
}

let lastShowNodeInfoId = null;
let lastShowNodeInfoTime = 0;

function showNodeInfo(nodeId) {
    // Debounce: Don't update if same node and called within 100ms
    const now = Date.now();
    if (nodeId === lastShowNodeInfoId && now - lastShowNodeInfoTime < 100) {
        return;
    }
    lastShowNodeInfoId = nodeId;
    lastShowNodeInfoTime = now;
    
    console.log('=== showNodeInfo called ===');
    console.log('nodeId:', nodeId);
    console.log('currentSlot:', currentSlot);
    console.log('selectedTree:', selectedTree);
    
    const node = currentTreeData[nodeId];
    if (!node) {
        console.log('No node found in currentTreeData');
        return;
    }
    
    const info = document.getElementById('tierInfo');
    const components = getComponentsForNodeInContext(nodeId);
    
    // Get costs for node only and full path
    const nodeOnlyCost = getNodeOnlyCost(nodeId);
    const pathCost = getCostsForPath(nodeId);
    
    // Calculate merit equivalents
    const nodeOnlyMeritEquiv = Math.floor(nodeOnlyCost.threads / 20) + nodeOnlyCost.empyrean;
    const pathMeritEquiv = Math.floor(pathCost.threads / 20) + pathCost.empyrean;
    
    // Format cost display with two columns
    let costHtml = `
        <div class="costs-two-column">
            <div class="cost-column">
                <div class="cost-header">NODE ONLY</div>
                <div class="cost-display">
                    ${nodeOnlyCost.threads > 0 ? `<div><span class="cost-threads">${nodeOnlyCost.threads}</span> Threads</div>` : ''}
                    ${nodeOnlyCost.threads > 0 || nodeOnlyCost.empyrean > 0 ? `<div><span class="cost-empyrean">${nodeOnlyCost.empyrean} (${nodeOnlyMeritEquiv})</span> Merits</div>` : ''}
                    ${nodeOnlyCost.threads === 0 && nodeOnlyCost.empyrean === 0 ? '<div>No cost</div>' : ''}
                </div>
            </div>
            <div class="cost-column">
                <div class="cost-header">FULL PATH</div>
                <div class="cost-display">
                    ${pathCost.threads > 0 ? `<div><span class="cost-threads">${pathCost.threads}</span> Threads</div>` : ''}
                    ${pathCost.threads > 0 || pathCost.empyrean > 0 ? `<div><span class="cost-empyrean">${pathCost.empyrean} (${pathMeritEquiv})</span> Merits</div>` : ''}
                    ${pathCost.threads === 0 && pathCost.empyrean === 0 ? '<div>No cost</div>' : ''}
                </div>
            </div>
        </div>
    `;
    
    // Debug: Log what components we're finding for this node
    console.log(`=== showNodeInfo for ${nodeId} ===`);
    console.log(`Node only cost: threads=${nodeOnlyCost.threads}, merits=${nodeOnlyCost.empyrean}, equiv=${nodeOnlyMeritEquiv}`);
    console.log(`Path cost: threads=${pathCost.threads}, merits=${pathCost.empyrean}, equiv=${pathMeritEquiv}`);
    
    // Get power info
    const powerInfo = getPowerInfo(currentSlot, selectedTree, nodeId);
    console.log('powerInfo result:', powerInfo);
    
    // Build components HTML
    let componentsHtml = '';
    let empyreanDisplay = '';
    if (pathCost.empyrean > 0) {
        empyreanDisplay = `<div class="tier-info-empyrean">Empyrean: <span class="cost-empyrean">${pathCost.empyrean} Merits (full path)</span></div>`;
    }
    
    // Get components for current tier and entire path
    const pathComponents = getAllComponentsForPath(currentSlot, selectedTree, nodeId);
    const consolidatedPathComponents = consolidateAndSortComponents(pathComponents);
    
    if (components && components.length > 0) {
        const colorizedComponents = components.map(c => colorizeComponent(c));
        const colorizedPathComponents = consolidatedPathComponents.map(c => colorizeComponent(c));
        componentsHtml = `
            <div class="tier-info-components">
                ${empyreanDisplay}
                <div class="components-two-column">
                    <div class="component-column">
                        <div class="component-title">Node Only</div>
                        <div class="component-list">
                            ${colorizedComponents.map(c => `<div class="component-item">${c}</div>`).join('')}
                        </div>
                    </div>
                    <div class="component-column">
                        <div class="component-title">Full Path</div>
                        <div class="component-list">
                            ${colorizedPathComponents.map(c => `<div class="component-item">${c}</div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (empyreanDisplay) {
        // Show empyrean even if no components
        componentsHtml = `
            <div class="tier-info-components">
                ${empyreanDisplay}
            </div>
        `;
    }
    
    let hintText = 'ðŸ’¡ Right-click T4 nodes to cycle through different T3 prerequisite combinations';
    if (node.tier === 4) {
        const combo = getCombinationLabel(nodeId);
        hintText = `Using combination: ${combo} (right-click to cycle)`;
    }
    
    info.innerHTML = `
        <div class="tier-info-title">${node.fullName}</div>
        <div class="tier-info-subtitle">${node.actualPowerName}</div>
        <div class="tier-info-desc">${powerInfo ? powerInfo.desc : node.desc}</div>
        ${costHtml}
        ${componentsHtml}
        <div class="tier-info-hint">${hintText}</div>
    `;
}
        
        function hideNodeInfo() {
            if (!selectedNode) {
                const info = document.getElementById('tierInfo');
                info.innerHTML = `
                    <div class="tier-info-title">Hover or click a node to see details</div>
                    <div class="tier-info-desc">
                        Click any tier node to select that power. Prerequisites will automatically highlight.
                    </div>
                    <div class="tier-info-hint">
                        ðŸ’¡ Right-click T4 nodes to cycle through different T3 prerequisite combinations
                    </div>
                `;
            }
        }
        
        function showTooltip(e, text) {
            const tooltip = document.getElementById('nodeTooltip');
            
            // Check if this is the selected node
            const nodeEl = e.target.closest('.tier-node');
            const isSelected = nodeEl && nodeEl.classList.contains('selected');
            
            if (isSelected) {
                tooltip.textContent = `${text} (Click to deselect)`;
            } else {
                tooltip.textContent = text;
            }
            
            tooltip.classList.add('show');
            updateTooltipPosition(e);
        }
        
        function updateTooltipPosition(e) {
            const tooltip = document.getElementById('nodeTooltip');
            const container = document.getElementById('tierGrid');
            const rect = container.getBoundingClientRect();
            
            const x = e.clientX - rect.left + 15;
            const y = e.clientY - rect.top - 10;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('nodeTooltip');
            tooltip.classList.remove('show');
        }

function clearSlotSelection(slot) {
    const panel = document.querySelector(`.slot-panel[data-slot="${slot}"]`);
    if (!panel) return;
    
    // Reset selection display
    panel.querySelector('.slot-selection').textContent = '-';
    panel.classList.remove('selected');
    
    // Clear icon
    const circle = panel.querySelector('.slot-icon-circle');
    circle.innerHTML = '<span class="empty-icon">+</span>';
    circle.classList.remove('filled');
    
    // Clear slot content
    const contentDiv = panel.querySelector('.slot-content');
    if (contentDiv) {
        contentDiv.innerHTML = '';
    }
    
    // Remove from tracked selections
    delete selectedPowers[slot];
    
    // Update totals display
    updateTotalsDisplay();
}

function populateSlotContent(slot, tree, nodeId) {
    // Get the slot panel and find its content div
    const panel = document.querySelector(`.slot-panel[data-slot="${slot}"]`);
    const contentDiv = panel.querySelector('.slot-content');
    if (!contentDiv) return;
    
    // Get components for this selection (full crafting path)
    const pathComponents = getAllComponentsForPath(slot, tree, nodeId);
    
    // Collect and aggregate components
    const components = {};
    pathComponents.forEach(salvageStr => {
        const match = salvageStr.match(/(\d+)x\s+(.+)/);
        if (match) {
            const qty = parseInt(match[1]);
            const name = match[2];
            
            if (!components[name]) {
                components[name] = {
                    quantity: 0,
                    rarity: getComponentRarity(name)
                };
            }
            components[name].quantity += qty;
        }
    });
    
    // Sort by rarity
    const rarityOrder = { 'common': 1, 'uncommon': 2, 'rare': 3, 'very-rare': 4 };
    const sortedComponents = Object.entries(components).sort((a, b) => {
        return rarityOrder[a[1].rarity] - rarityOrder[b[1].rarity];
    });
    
    // Build HTML for slot content
    if (sortedComponents.length === 0) {
        contentDiv.innerHTML = '<div class="component-row"><span class="component-name">No components required</span></div>';
    } else {
        contentDiv.innerHTML = sortedComponents.map(([name, data]) => {
            return `<div class="component-row"><span class="component-name component-${data.rarity}">${data.quantity}x ${name}</span></div>`;
        }).join('');
    }
}

function confirmSelection() {
    if (!selectedNode) return;
    
    const panel = document.querySelector(`.slot-panel[data-slot="${currentSlot}"]`);
    const node = currentTreeData[selectedNode];
    
    // Update selection text and icon
    panel.querySelector('.slot-selection').textContent = node.name;
    panel.classList.add('selected');
    
    const circle = panel.querySelector('.slot-icon-circle');
    circle.innerHTML = `<img src="${getIconPath(selectedNode)}" alt="${node.name}">`;
    circle.classList.add('filled');
    
    // Track selection for totals calculation
    selectedPowers[currentSlot] = {
        nodeId: selectedNode,
        tree: selectedTree,
        node: node
    };
    
    // Populate the slot's content div with component breakdown
    populateSlotContent(currentSlot, selectedTree, selectedNode);
    
    // Update totals
    updateTotalsDisplay();
    
    closeSelectorModal();
}
// Initialize totals display
document.addEventListener('DOMContentLoaded', () => {
    updateTotalsDisplay();
});
    </script>
</body>
</html>
