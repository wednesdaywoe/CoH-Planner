/**
 * Convert legacy epic pool JavaScript files to TypeScript data module
 *
 * Usage: node scripts/convert-epic-pools.js
 */

const fs = require('fs');
const path = require('path');

// Source and destination paths
const LEGACY_EPICS_DIR = 'C:/Projects/legacy-CoH-Planner/js/data/epics';
const OUTPUT_FILE = path.join(__dirname, '..', 'src', 'data', 'epic-pools-raw.ts');

// Archetype folders to process
const ARCHETYPE_FOLDERS = [
  'arachnos_soldier',
  'blaster',
  'brute',
  'controller',
  'corruptor',
  'defender',
  'dominator',
  'mastermind',
  'scrapper',
  'sentinel',
  'stalker',
  'tanker'
];

/**
 * Extract JSON object from legacy JavaScript file
 */
function extractEpicPoolData(fileContent) {
  // Find the JSON object definition between = { and };
  const match = fileContent.match(/=\s*(\{[\s\S]*?\});?\s*(?:\/\/|$)/);
  if (!match) {
    return null;
  }

  try {
    // Parse the JSON (it's already valid JSON format in these files)
    return JSON.parse(match[1]);
  } catch (e) {
    console.error('Failed to parse JSON:', e.message);
    return null;
  }
}

/**
 * Process all epic pool files
 */
function processAllEpicPools() {
  const allPools = {};
  let totalCount = 0;
  const poolsByArchetype = {};

  for (const archetype of ARCHETYPE_FOLDERS) {
    const archetypeDir = path.join(LEGACY_EPICS_DIR, archetype);

    if (!fs.existsSync(archetypeDir)) {
      console.warn(`Archetype directory not found: ${archetypeDir}`);
      continue;
    }

    const files = fs.readdirSync(archetypeDir).filter(f => f.endsWith('.js'));
    poolsByArchetype[archetype] = 0;

    for (const file of files) {
      const filePath = path.join(archetypeDir, file);
      const content = fs.readFileSync(filePath, 'utf-8');

      const poolData = extractEpicPoolData(content);
      if (poolData && poolData.id) {
        allPools[poolData.id] = poolData;
        totalCount++;
        poolsByArchetype[archetype]++;
        console.log(`  Processed: ${poolData.id} (${poolData.name})`);
      } else {
        console.warn(`  Failed to extract: ${file}`);
      }
    }
  }

  return { allPools, totalCount, poolsByArchetype };
}

/**
 * Generate TypeScript output
 */
function generateTypeScript(allPools, totalCount, poolsByArchetype) {
  const archetypeStats = JSON.stringify(poolsByArchetype);

  const output = `/**
 * Raw Epic/Patron Pool data
 * Auto-generated from legacy/js/data/epics/
 *
 * DO NOT EDIT THIS FILE DIRECTLY
 * Run: node scripts/convert-epic-pools.js
 *
 * Total pools: ${totalCount}
 * Archetypes: ${archetypeStats}
 */

export const EPIC_POOLS_RAW = ${JSON.stringify(allPools, null, 2)};
`;

  return output;
}

// Main execution
console.log('Converting epic pool files...\n');

const { allPools, totalCount, poolsByArchetype } = processAllEpicPools();

console.log(`\nTotal pools converted: ${totalCount}`);
console.log('Pools by archetype:', poolsByArchetype);

const tsContent = generateTypeScript(allPools, totalCount, poolsByArchetype);
fs.writeFileSync(OUTPUT_FILE, tsContent);

console.log(`\nOutput written to: ${OUTPUT_FILE}`);
